# èƒ½é‡èˆ‡é€Ÿåº¦å¸¸é‡
ENERGY_BAR_MAX = 200        # èƒ½é‡ç´¯ç©ä¸Šé™ (æœ€å¤§å€¼)
SHOOT_SPEED = 35            # åŸºç¤å°„æ“Šé€Ÿåº¦ (æ‚¨è¨­å®šçš„ 35)
FAST_SHOOT_SPEED = 60       # å¿«é€Ÿæ¨¡å¼å°„æ“Šé€Ÿåº¦ (æ‚¨è¨­å®šçš„ 60)
FAST_MODE_DURATION = 5      # å¿«é€Ÿæ¨¡å¼æŒçºŒæ™‚é–“ (ç§’)
ENERGY_IMPACT_BUBBLE_SCORE = 10 # èƒ½é‡è¡æ“Šå–®å€‹æ³¡æ³¡å¾—åˆ†
class Game:
    def __init__(self):
        # ... (å…¶ä»–åˆå§‹åŒ–ç•¥)
        
        self.ENERGY_BAR_MAX = ENERGY_BAR_MAX 
        self.current_energy = 0        # ç•¶å‰èƒ½é‡å€¼ (å¾ 0 é–‹å§‹)
        self.is_impact_ready = False   # èƒ½é‡æ˜¯å¦å……æ»¿ï¼Œå¯ä»¥ç™¼å‹•è¡æ“Š
        
        self.is_fast_mode = False      # æ˜¯å¦è™•æ–¼å¿«é€Ÿæ¨¡å¼
        self.fast_mode_timer = 0       # å¿«é€Ÿæ¨¡å¼çš„è¨ˆæ™‚å™¨èµ·é»
        self.FAST_MODE_DURATION = FAST_MODE_DURATION
        
        # ...
        self.reset_game()
def clear_matches(self, matches):
        if len(matches) >= 3:
            # ... (æ¸…é™¤æ³¡æ³¡å’Œè¨ˆç®—å¾—åˆ†çš„é‚è¼¯ç•¥)
            
            total_energy_gained = 0 # æ–°å¢ä¸€å€‹è®Šæ•¸ä¾†å„²å­˜é€™æ³¢æ¶ˆé™¤ç²å¾—çš„ç¸½èƒ½é‡

            for r, c in matches:
                bubble = self.grid[r][c]
                if bubble:
                    total_energy_gained += bubble.energy  # <-- å¾æ³¡æ³¡ä¸­ç²å–èƒ½é‡
                    # ... (å…¶é¤˜æ¸…é™¤é‚è¼¯ç•¥)
            
            # ... (å¾—åˆ†é‚è¼¯ç•¥)
            
            # æ›´æ–°èƒ½é‡æ¢
            if total_energy_gained > 0:
                self.current_energy += total_energy_gained
                self.current_energy = min(self.current_energy, self.ENERGY_BAR_MAX)
                
                # æª¢æŸ¥æ˜¯å¦å……æ»¿èƒ½é‡
                if self.current_energy >= self.ENERGY_BAR_MAX and not self.is_impact_ready:
                    self.is_impact_ready = True
                    self.notification_text = "âœ¨ èƒ½é‡è¡æ“Šå°±ç·’ï¼(æŒ‰ E éµ)"
                    self.notification_timer = pygame.time.get_ticks()

            # ... (å…¶é¤˜é‚è¼¯ç•¥)
            return cleared_count > 0
        return False
def trigger_energy_impact(self):
        # ç¢ºä¿èƒ½é‡å·²æ»¿ä¸”éŠæˆ²æ­£åœ¨é€²è¡Œ
        if not self.is_impact_ready or self.current_state != GameState.PLAYING:
            return

        # æ ¹æ“šèƒ½é‡å€¼æ±ºå®šè¦å¼•çˆ†çš„æ³¡æ³¡æ•¸é‡
        detonation_count = self.current_energy // 10 
        detonation_count = max(5, min(detonation_count, 50)) # æœ€å°‘ 5 å€‹ï¼Œæœ€å¤š 50 å€‹

        self.current_energy = 0        # æ¶ˆè€—æ‰€æœ‰èƒ½é‡
        self.is_impact_ready = False   # ç‹€æ…‹é‡ç½®
        
        # æ‰¾å‡ºæ‰€æœ‰ç¶²æ ¼ä¸Šçš„ç›®æ¨™æ³¡æ³¡
        possible_targets = []
        for r in range(ROWS):
            for c in range(COLS):
                if self.grid[r][c] is not None:
                    possible_targets.append((r, c))
                    
        # éš¨æ©Ÿé¸å–è¦å¼•çˆ†çš„æ³¡æ³¡
        targets_to_detonate = random.sample(possible_targets, min(detonation_count, len(possible_targets)))
        
        detonated_score = 0
        for r, c in targets_to_detonate:
            bubble = self.grid[r][c]
            if bubble:
                # å°‡æ³¡æ³¡æ¨™è¨˜ç‚ºæ‰è½ä¸¦å¾ç¶²æ ¼ä¸­ç§»é™¤
                bubble.is_falling = True
                self.falling_bubbles.append(bubble)
                self.grid[r][c] = None
                detonated_score += ENERGY_IMPACT_BUBBLE_SCORE
                
        self.score += detonated_score
        
        if detonated_score > 0:
            # === å•Ÿå‹•å¿«é€Ÿå°„æ“Šæ¨¡å¼ ===
            self.is_fast_mode = True
            self.fast_mode_timer = pygame.time.get_ticks()
            
            # é¡¯ç¤ºé€šçŸ¥
            self.notification_text = f"ğŸ’¥ èƒ½é‡è¡æ“Šï¼å¿«é€Ÿæ¨¡å¼å•Ÿå‹• ({self.FAST_MODE_DURATION} ç§’)ï¼"
            self.notification_timer = pygame.time.get_ticks()
            self.check_for_floating_bubbles() # æª¢æŸ¥æ˜¯å¦æœ‰å‰©é¤˜çš„æµ®å‹•æ³¡æ³¡
def update(self):
        if self.current_state != GameState.PLAYING:
            return
            
        current_time = pygame.time.get_ticks()
        # ... (æ™‚é–“è¨ˆç®—ç•¥)

        if self.is_fast_mode:
            # è¨ˆç®—å¾å•Ÿå‹•åˆ°ç¾åœ¨ç¶“éçš„æ™‚é–“
            if (current_time - self.fast_mode_timer) / 1000.0 >= self.FAST_MODE_DURATION:
                self.is_fast_mode = False # é—œé–‰å¿«é€Ÿæ¨¡å¼
                self.notification_text = "å¿«é€Ÿæ¨¡å¼çµæŸã€‚"
                self.notification_timer = pygame.time.get_ticks()
        
        # ... (æ™‚é–“é™åˆ¶ã€æ³¡æ³¡æ›´æ–°ç­‰é‚è¼¯ç•¥)
def _handle_playing_click(self, x, y):
        # ... (éŒ˜å­æ¨¡å¼å’Œé“å…·é»æ“Šè™•ç†ç•¥)

        if y < POWER_UP_AREA_Y and not self.is_shooting:
            # ... (è¨ˆç®—æ–¹å‘å‘é‡ç•¥)
            
            if dy < 0:
                dist = math.sqrt(dx**2 + dy**2)
                
                # æ ¹æ“šæ¨¡å¼é¸æ“‡é€Ÿåº¦
                speed = FAST_SHOOT_SPEED if self.is_fast_mode else SHOOT_SPEED 
                
                self.shooter_bubble.vel_x = (dx / dist) * speed
                self.shooter_bubble.vel_y = (dy / dist) * speed
                self.is_shooting = True
